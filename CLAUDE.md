# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a creative writing project repository. It contains tools and a suggested structure for managing manuscripts, character profiles, and world-building documents.

## Repository Structure

### NovelEnv Tool Repository (this repository)

This is the structure of the novelenv tools repository:

```
novelenv/
â”œâ”€â”€ character_profile/     # Sample character profiles  
â”œâ”€â”€ scene_sketch/         # Sample scene drafts and snippets
â”œâ”€â”€ writing_style/        # Default writing style templates
â”‚   â”œâ”€â”€ always.md         # Base writing guidelines
â”‚   â”œâ”€â”€ combat_heroic.md  # Heroic combat descriptions
â”‚   â”œâ”€â”€ combat_tension.md # Tense combat scenes
â”‚   â”œâ”€â”€ emotion_focused.md # Emotion-driven narratives
â”‚   â”œâ”€â”€ horror.md         # Horror atmosphere
â”‚   â”œâ”€â”€ psycho_horror.md  # Psychological horror
â”‚   â”œâ”€â”€ sensual.md        # Sensual descriptions
â”‚   â””â”€â”€ splatter_horror.md # Graphic horror
â”œâ”€â”€ cli-tools/            # Command-line utilities
â”‚   â”œâ”€â”€ context-weaver/   # Narrative context management
â”‚   â”œâ”€â”€ dump-episode-info/ # Episode index generator
â”‚   â”œâ”€â”€ find-context/     # Context search tool
â”‚   â”œâ”€â”€ novel-init/       # Project initialization
â”‚   â”œâ”€â”€ pick-name/        # Character name generator
â”‚   â””â”€â”€ novelenv/         # Environment setup
â”œâ”€â”€ novelenv.toml.example     # Configuration template
â”œâ”€â”€ install.sh            # Installation script
â”œâ”€â”€ run_claude_command.sh # Helper script
â””â”€â”€ CLAUDE.md            # This file
```

### Individual Novel Project Structure (created by `novel init`)

When you run `novel init project-name`, the following structure is created:

```
project-name/
â”œâ”€â”€ character_profile/     # Character profiles and development
â”œâ”€â”€ episode/              # Story episodes and chapters  
â”œâ”€â”€ scene_sketch/         # Generated scene drafts and snippets
â”œâ”€â”€ summary/              # Episode summaries and story outlines
â”œâ”€â”€ environment/          # World-building and environmental settings (replaces 'official')
â”œâ”€â”€ notes/               # Concepts, mechanisms, and technical explanations (replaces 'scrap')
â”œâ”€â”€ writing_style/        # Writing style guidelines
â”‚   â””â”€â”€ always.md         # Auto-generated base guidelines
â”œâ”€â”€ .novelenv/            # Machine-generated data directory
â”‚   â”œâ”€â”€ narratives.json   # Context weaver narrative storage
â”‚   â”œâ”€â”€ episode_index.json # Episode index (generated by dump-episode-info)
â”‚   â””â”€â”€ name_history.txt  # Name picker usage history
â”œâ”€â”€ novelenv.toml         # Project-specific configuration
â”œâ”€â”€ CLAUDE.md            # Project-specific instructions
â””â”€â”€ README.md            # Project documentation
```

**Key Changes from Earlier Versions:**
- `official/` â†’ `environment/` (for world-building and environmental settings)
- `scrap/` â†’ `notes/` (for general notes and ideas)
- `find_context.toml` â†’ `novelenv.toml` (unified configuration for all CLI tools)
- Machine-generated files moved to `.novelenv/` directory
- Each project gets its own `novelenv.toml` configuration
- Each project gets its own `CLAUDE.md` with project-specific instructions

## NovelEnv v2 Project Management

NovelEnv v2 uses a unified `novel` command to manage projects. Each novel project is created as a separate directory with its own Git repository.

### Project Creation

Use `novel init` to create a new novel project:

```bash
# Create a new project
./cli-tools/novel-init/target/release/novel-init my-novel

# This creates a complete project structure with:
# - All necessary directories
# - Project-specific CLAUDE.md
# - Configured novelenv.toml
# - Writing style templates
# - .novelenv directory for machine-generated data
```

### Project Structure

Each project is self-contained and can be managed as its own Git repository:

```bash
cd my-novel
git init
git add .
git commit -m "Initial project setup"
```

## Common Tasks

### Text Generation
When asked to "generate text" without specific save location instructions:
- Create files in the `scene_sketch/` directory.
- Use descriptive names for the `.md` files.
- Follow any writing style guidelines found in the `writing_style/` directory.

**Important for Task tool usage**: When using the Task tool to generate content:
- The Task agent should always report the exact filename it created in its response.
- Example: "Created scene at: scene_sketch/character_interaction_theme.md"
- This ensures the main agent can directly access the created file without searching.

## Important Notes

- This is a pure content repository; no build, test, or lint commands are expected to exist for the content itself.
- The focus is on narrative consistency.

## Utility Tools

This repository includes several command-line tools to assist with writing and content management.

### `context-weaver` Tool Usage Guide

Context Weaver is a narrative context management tool that helps manage and resolve complex context for creative writing projects.

#### Start the Web UI Server

```bash
# From project root directory
./cli-tools/context-weaver/target/release/weaver serve --port 3000

# Or specify path explicitly
./cli-tools/context-weaver/target/release/weaver serve --port 3000 --path /path/to/your/project
```

This starts a web server at http://localhost:3000 where you can:
- Browse project files in a tree view
- Create narrative contexts by dragging and dropping files
- Save narratives with unique IDs
- Download resolved contexts

#### Resolve a Narrative Context from CLI

```bash
# From project root directory (recommended)
./cli-tools/context-weaver/target/release/weaver resolve <NARRATIVE_ID>

# Or specify path explicitly
./cli-tools/context-weaver/target/release/weaver resolve <NARRATIVE_ID> --path /path/to/your/project
```

This outputs the resolved context (all included files concatenated) to stdout. The `--path` option is optional when running from the project root directory.

#### Usage in Claude Code

When a user references a narrative ID, use the resolve command to get the full context:

```bash
# Recommended: Run from project root directory
./cli-tools/context-weaver/target/release/weaver resolve 123e4567-e89b-12d3-a456-426614174000

# Alternative: Specify path explicitly if needed
./cli-tools/context-weaver/target/release/weaver resolve 123e4567-e89b-12d3-a456-426614174000 --path /path/to/your/project
```

The tool will:
- Load the narrative configuration from `.weaver-narratives.json`
- Resolve all file includes (full files, sections, or line ranges)
- Output the concatenated context to stdout

### `find-context` Tool Usage Guide

#### Primary Principle: Contextual Search

When searching for context-dependent information (e.g., character profiles, configuration files), **you must always use the `find-context` tool first.**

Do **not** use general-purpose search tools like `grep`, `rg`, `glob`, or `find` for this purpose initially. The `find-context` tool is the single source of truth for resolving project-specific aliases and file structures.

#### The Tool's Result is Absolute

The output from the `find-context` tool is the **Ground Truth** for this project.

- **If the tool returns content**: Use that content as the sole correct answer.
- **If the tool returns "not found"**: Do **not** search further.
  - Do not speculate that the file might exist elsewhere.
  - Do not try to re-search with different keywords based on user intent.
  - Immediately report to the user that the information was not found according to the tool. This ensures fast and reliable feedback.

#### Your Thought Process

Your thought process for contextual searches should be as follows:

1.  Receive a request from the user, e.g., "Find information on '[character_name]'."
2.  Identify this as a contextual search.
3.  Recall this guideline and select the `find-context` tool as the **highest priority**.
4.  Execute the tool with the appropriate subcommand and arguments.
5.  Act according to the rules above based on the result.

Adhering to this process eliminates inefficient detours and provides the best results for both the LLM and the user.

#### Configuration

The tool reads configuration from `novelenv.toml` (preferred) or `find_context.toml` (legacy) in the project root.

#### Usage Examples

The tool is located at `./cli-tools/find-context/target/release/find-context`.

**To get a character profile:**

- **By alias:** If an alias is configured for a character.
  ```sh
  ./cli-tools/find-context/target/release/find-context profile [character_alias]
  ```
  *(This will succeed and print the content of the corresponding profile file.)*

- **By direct name:**
  ```sh
  ./cli-tools/find-context/target/release/find-context profile [character_name]
  ```
  *(This will also succeed and print the content of `character_profile/[character_name].md`)*

- **When a profile does not exist:**
  ```sh
  ./cli-tools/find-context/target/release/find-context profile non_existent_character
  ```
  *(This will fail with a "not found" error, and you should report that immediately.)*

**To find episodes featuring a character:**

This requires an up-to-date `episode_index.json` file in `.novelenv/` or project root. If the command fails, it might be because the index is missing or outdated. You can regenerate it by running the `dump-episode-info` tool.

- **Example:** Find all episodes featuring a character.
  ```sh
  ./cli-tools/find-context/target/release/find-context episode --character [character_name]
  ```
  *(This will succeed and print a list of episode paths and their loglines.)*

### `dump-episode-info` Tool

This tool generates the `episode_index.json` file in the `.novelenv/` directory, which is required by the `find-context episode` command. It uses an LLM to read each episode file and extract structured data.

- **Usage**: `(cd cli-tools/dump-episode-info && cargo run)`
- **Configuration**: Reads from `novelenv.toml` (preferred) or `find_context.toml` (legacy)
- **Output**: Creates `.novelenv/episode_index.json` (or legacy location based on config)
- **Note**: This command calls an LLM multiple times and may take a while to complete.

### `novel style` Command Usage Guide

The `novel style` command allows you to manage writing style templates in your project. This is particularly useful when NovelEnv is updated with new writing styles after you've created your project.

#### List Available and Installed Styles

```bash
# Show all available styles with their installation status
novel style list
```

Output example:
```
ğŸ“ Writing Styles:

âœ… always (installed)
ğŸ†• combat_heroic (available)
âœ… combat_tension (installed)
ğŸ†• emotion_focused (available)
...
```

#### Install a New Style

```bash
# Install a specific writing style to your project
novel style install combat_tension --local

# The --local flag is currently the default (reserved for future expansion)
novel style install horror
```

This copies the specified style template from the global NovelEnv installation to your project's `writing_style/` directory.

#### View Style Information

```bash
# Display the first 20 lines of a style template
novel style info combat_tension

# Shows whether it's installed locally or available globally
novel style info psycho_horror
```

#### Use Cases

1. **After NovelEnv Update**: When new writing styles are added to NovelEnv, existing projects can adopt them:
   ```bash
   # Check what's new
   novel style list
   
   # Install the ones you want
   novel style install combat_heroic
   ```

2. **Mid-Project Style Additions**: Add genre-specific styles as your story evolves:
   ```bash
   # Your story takes a dark turn
   novel style install horror
   novel style install psycho_horror
   ```

3. **Style Preview**: Check what a style offers before installing:
   ```bash
   novel style info splatter_horror
   ```

### `pick-name` Tool

This tool generates random character names for temporary/mob characters in scene sketches, avoiding common LLM name choices that may feel repetitive.

**Usage via novel command:**
```bash
# Given names only (default)
novel pick-name -- --genre fantasy --gender male                    # â†’ "ã‚»ãƒ©ã‚¹"
novel pick-name -- --genre fantasy --gender female                  # â†’ "ã‚¨ãƒ©"
novel pick-name -- --genre japanese --gender male                   # â†’ "è“®å¸"
novel pick-name -- --genre japanese --gender female                 # â†’ "åƒæ™´"
novel pick-name -- --genre modern --gender male                     # â†’ "Blake"
novel pick-name -- --genre modern --gender female                   # â†’ "Harper"

# Full names (given + family)
novel pick-name -- --genre fantasy --gender male --format full      # â†’ "ã‚»ãƒ©ã‚¹ ãƒ‰ãƒ©ã‚´ãƒ³ãƒãƒ¼ãƒˆ"
novel pick-name -- --genre fantasy --gender female --format full    # â†’ "ã‚¨ãƒ© ã‚·ãƒ«ãƒãƒ¼ãƒ ãƒ¼ãƒ³"
novel pick-name -- --genre japanese --gender male --format full     # â†’ "é«˜ç€¬ è“®å¸"
novel pick-name -- --genre japanese --gender female --format full   # â†’ "è’¼äº• åƒæ™´"
novel pick-name -- --genre modern --gender male --format full       # â†’ "Blake Johnson"
novel pick-name -- --genre modern --gender female --format full     # â†’ "Harper Smith"
```

**History management:**
```bash
novel pick-name -- --show-history                     # View recent name usage
novel pick-name -- --clear-history                    # Clear usage history
novel pick-name -- --genre fantasy --gender male --ignore-history  # Ignore history
```

**When to use:**
- For temporary characters in scene sketches
- When you need a quick name for background characters
- To avoid repetitive LLM name patterns
- NOT for main characters (humans should name important characters)

The tool uses curated name lists that exclude commonly overused names and problematic associations identified in `character_profile/character_creation.md`. History is stored in `.novelenv/name_history.txt` in a simple `category:name` format.
