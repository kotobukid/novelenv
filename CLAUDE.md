# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a creative writing project repository. It contains tools and a suggested structure for managing manuscripts, character profiles, and world-building documents.

## Repository Structure

A typical project might be structured as follows:

```
project/
├── character_profile/     # Character profiles
├── episode/              # Story episodes or chapters
├── scene_sketch/         # Generated scene drafts and snippets
├── summary/              # Summaries of episodes
├── official/             # World-building, rules, and concept documents
├── writing_style/        # Writing style guidelines
└── episode_index.json    # Index of episodes, generated by a tool
```

## Git Repository Management

This project supports managing novelenv (the tools) and individual novel projects as separate Git repositories. Helper scripts are provided to facilitate file movement and symlink management between novelenv and novel projects.

### Helper Scripts

#### `move-to-project.sh` - Move a single file to a novel project

Moves a file from novelenv to a target novel project and creates a symlink back to it.

```bash
# Usage
./move-to-project.sh <source-file> <target-project-path>

# Example
./move-to-project.sh character_profile/alice.md /path/to/my-novel
```

This will:
1. Move `character_profile/alice.md` to `/path/to/my-novel/character_profile/alice.md`
2. Create a symlink at the original location pointing to the moved file

#### `move-all-to-project.sh` - Batch move files to a novel project

Moves all .md files from specified directories to a target project, creating symlinks for each.

```bash
# Move files from default directories (character_profile, episode, scene_sketch, summary, official)
./move-all-to-project.sh /path/to/my-novel

# Move files from specific directories only
./move-all-to-project.sh /path/to/my-novel character_profile episode
```

Features:
- Skips files that are already symlinks
- Creates target directories as needed
- Provides a summary of moved and skipped files

#### `link-from-project.sh` - Create symlinks to existing project files

Creates symlinks in novelenv pointing to files that already exist in a novel project.

```bash
# Auto-detect target path based on directory structure
./link-from-project.sh /path/to/my-novel/character_profile/bob.md

# Explicitly specify the novelenv path
./link-from-project.sh /path/to/my-novel/character_profile/bob.md character_profile/bob_alias.md
```

### Typical Workflow

1. **Initial Setup**: Generate content in novelenv using Claude Code
2. **Move to Project**: Use `move-all-to-project.sh` to move generated files to your novel's Git repository
3. **Continue Working**: The symlinks allow you to continue working in novelenv while files are stored in the novel project
4. **Link Existing Files**: Use `link-from-project.sh` to make existing project files accessible in novelenv

### Example Workflow

```bash
# 1. Create content in novelenv
# (Claude Code generates files in character_profile/, episode/, etc.)

# 2. Initialize your novel project
mkdir ~/my-novel
cd ~/my-novel
git init

# 3. Move all generated content to the novel project
cd ~/projects/novelenv
./move-all-to-project.sh ~/my-novel

# 4. The novel project now contains the actual files
# novelenv contains symlinks to these files

# 5. Commit in the novel project
cd ~/my-novel
git add .
git commit -m "Initial character profiles and episodes"

# 6. Continue working - any edits through novelenv symlinks
# will modify the files in the novel project
```

## Common Tasks

### Text Generation
When asked to "generate text" without specific save location instructions:
- Create files in the `scene_sketch/` directory.
- Use descriptive names for the `.md` files.
- Follow any writing style guidelines found in the `writing_style/` directory.

**Important for Task tool usage**: When using the Task tool to generate content:
- The Task agent should always report the exact filename it created in its response.
- Example: "Created scene at: scene_sketch/character_interaction_theme.md"
- This ensures the main agent can directly access the created file without searching.

## Important Notes

- This is a pure content repository; no build, test, or lint commands are expected to exist for the content itself.
- The focus is on narrative consistency.

## Utility Tools

This repository includes several command-line tools to assist with writing and content management.

### `context-weaver` Tool Usage Guide

Context Weaver is a narrative context management tool that helps manage and resolve complex context for creative writing projects.

#### Start the Web UI Server

```bash
# From project root directory
./cli-tools/context-weaver/target/release/weaver serve --port 3000

# Or specify path explicitly
./cli-tools/context-weaver/target/release/weaver serve --port 3000 --path /path/to/your/project
```

This starts a web server at http://localhost:3000 where you can:
- Browse project files in a tree view
- Create narrative contexts by dragging and dropping files
- Save narratives with unique IDs
- Download resolved contexts

#### Resolve a Narrative Context from CLI

```bash
# From project root directory (recommended)
./cli-tools/context-weaver/target/release/weaver resolve <NARRATIVE_ID>

# Or specify path explicitly
./cli-tools/context-weaver/target/release/weaver resolve <NARRATIVE_ID> --path /path/to/your/project
```

This outputs the resolved context (all included files concatenated) to stdout. The `--path` option is optional when running from the project root directory.

#### Usage in Claude Code

When a user references a narrative ID, use the resolve command to get the full context:

```bash
# Recommended: Run from project root directory
./cli-tools/context-weaver/target/release/weaver resolve 123e4567-e89b-12d3-a456-426614174000

# Alternative: Specify path explicitly if needed
./cli-tools/context-weaver/target/release/weaver resolve 123e4567-e89b-12d3-a456-426614174000 --path /path/to/your/project
```

The tool will:
- Load the narrative configuration from `.weaver-narratives.json`
- Resolve all file includes (full files, sections, or line ranges)
- Output the concatenated context to stdout

### `find-context` Tool Usage Guide

#### Primary Principle: Contextual Search

When searching for context-dependent information (e.g., character profiles, configuration files), **you must always use the `find-context` tool first.**

Do **not** use general-purpose search tools like `grep`, `rg`, `glob`, or `find` for this purpose initially. The `find-context` tool is the single source of truth for resolving project-specific aliases and file structures.

#### The Tool's Result is Absolute

The output from the `find-context` tool is the **Ground Truth** for this project.

- **If the tool returns content**: Use that content as the sole correct answer.
- **If the tool returns "not found"**: Do **not** search further.
  - Do not speculate that the file might exist elsewhere.
  - Do not try to re-search with different keywords based on user intent.
  - Immediately report to the user that the information was not found according to the tool. This ensures fast and reliable feedback.

#### Your Thought Process

Your thought process for contextual searches should be as follows:

1.  Receive a request from the user, e.g., "Find information on '[character_name]'."
2.  Identify this as a contextual search.
3.  Recall this guideline and select the `find-context` tool as the **highest priority**.
4.  Execute the tool with the appropriate subcommand and arguments.
5.  Act according to the rules above based on the result.

Adhering to this process eliminates inefficient detours and provides the best results for both the LLM and the user.

#### Usage Examples

The tool is located at `./cli-tools/find-context/target/release/find-context`.

**To get a character profile:**

- **By alias:** If an alias is configured for a character.
  ```sh
  ./cli-tools/find-context/target/release/find-context profile [character_alias]
  ```
  *(This will succeed and print the content of the corresponding profile file.)*

- **By direct name:**
  ```sh
  ./cli-tools/find-context/target/release/find-context profile [character_name]
  ```
  *(This will also succeed and print the content of `character_profile/[character_name].md`)*

- **When a profile does not exist:**
  ```sh
  ./cli-tools/find-context/target/release/find-context profile non_existent_character
  ```
  *(This will fail with a "not found" error, and you should report that immediately.)*

**To find episodes featuring a character:**

This requires an up-to-date `episode_index.json` file. If the command fails, it might be because the index is missing or outdated. You can regenerate it by running the `dump-episode-info` tool.

- **Example:** Find all episodes featuring a character.
  ```sh
  ./cli-tools/find-context/target/release/find-context episode --character [character_name]
  ```
  *(This will succeed and print a list of episode paths and their loglines.)*

### `dump-episode-info` Tool

This tool generates the `episode_index.json` file, which is required by the `find-context episode` command. It uses an LLM to read each episode file and extract structured data.

- **Usage**: `(cd cli-tools/dump-episode-info && cargo run)`
- **Note**: This command calls an LLM multiple times and may take a while to complete.
